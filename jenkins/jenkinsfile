pipeline {
  agent any

  environment {
    AWS_REGION = "us-east-1"
    ECR_REPO = "343218213278.dkr.ecr.us-east-1.amazonaws.com/flask-ecr-demo"
    IMAGE_TAG = "${GIT_COMMIT}"
  }

  stages {

    stage('Checkout') {
      steps {
        git credentialsId: 'github-creds',
        url: 'https://github.com/iamonkarlad/Automated-Docker-Image-Deployment-to-Amazon-ECR-with-Jenkins-and-Lambda-Integration-.git'
      }
    }

    stage('Build Image') {
      steps {
        sh 'docker build -t flask-app:${IMAGE_TAG} app/'
      }
    }

    stage('Login to ECR') {
      steps {
        sh '''
        aws ecr get-login-password --region $AWS_REGION |
        docker login --username AWS --password-stdin $ECR_REPO
        '''
      }
    }

    stage('Push Image') {
      steps {
        sh '''
        docker tag flask-app:${IMAGE_TAG} $ECR_REPO:${IMAGE_TAG}
        docker push $ECR_REPO:${IMAGE_TAG}
        '''
      }
    }
  }

  post {
    success {
      sh '''
      aws lambda invoke \
        --function-name ecr-post-deploy-lambda \
        --payload '{"image":"'"$IMAGE_TAG"'"}' output.json
      '''
    }
  }
}

